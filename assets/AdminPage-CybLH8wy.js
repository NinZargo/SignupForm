import{r as d,j as e,i as o,B as u,P as S,f as $,D as L,x as j,$ as N,a0 as k,a1 as B,a2 as P,L as R,b as F,e as q,I as C,a3 as M,a4 as U}from"./vendor-DhX4SPbH.js";import{s as p}from"./index-CdVIviXw.js";const O=(g,m,h)=>{const x=["Event Name","Event Date","Member Name","Student Number","Role","Can Drive","Needs Transport","Status"],f=g.map(i=>[`"${m}"`,`"${h}"`,`"${i.name}"`,`"${i.student_number||""}"`,`"${i.role}"`,i.can_drive,i.transport_needed,`"${i.status}"`].join(","));return[x.join(","),...f].join(`
`)};function z(){const[g,m]=d.useState([]),[h,x]=d.useState([]),[f,i]=d.useState(!0),[v,E]=d.useState(null);async function _(){try{const{data:s,error:t}=await p.rpc("get_event_transport_details");if(t)throw t;const a=new Date;a.setHours(0,0,0,0);const n=[],c=[];(s||[]).forEach(r=>{new Date(r.event_date)>=a?n.push(r):c.push(r)}),m(n.sort((r,l)=>new Date(r.event_date)-new Date(l.event_date))),x(c.sort((r,l)=>new Date(l.event_date)-new Date(r.event_date)))}catch(s){console.error("Error fetching admin data:",s),E(s.message)}finally{i(!1)}}d.useEffect(()=>{_()},[]);const w=async(s,t)=>{const{error:a}=await p.from("signups").update({status:t}).eq("id",s);a?alert("Failed to update status."):await _()},I=s=>{if(!s.members||s.members.length===0){alert("There are no signups to export for this event.");return}const t=O(s.members,s.event_name,s.event_date),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),c=URL.createObjectURL(a);n.setAttribute("href",c);const r=s.event_name.replace(/[^a-z0-9]/gi,"_").toLowerCase();n.setAttribute("download",`${r}_signups.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)},A=async()=>{alert("Starting image caching process. This may take a few moments. Check the console for progress.");const{data:s,error:t}=await p.from("events").select("id, image_url").like("image_url","http%");if(t)return alert(`Error fetching old events: ${t.message}`);if(s.length===0)return alert("No old images to cache!");console.log(`Found ${s.length} events to migrate.`);for(const a of s)try{console.log(`Caching image for event ID: ${a.id}`);const c=await(await fetch(a.image_url)).blob(),r=`${Date.now()}_${a.id}.jpeg`,{data:l,error:b}=await p.storage.from("event-images").upload(r,c);if(b)throw b;const{error:D}=await p.from("events").update({image_url:l.path}).eq("id",a.id);if(D)throw D;console.log(`Successfully cached image for event ID: ${a.id}`)}catch(n){console.error(`Failed to cache image for event ${a.id}:`,n)}alert("Image caching process complete! Please refresh the page.")},y=s=>e.jsxs(S,{sx:{mb:3,p:3,boxShadow:3,borderRadius:2},children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(o,{variant:"h5",children:s.event_name}),e.jsx(o,{variant:"body2",color:"textSecondary",children:new Date(s.event_date).toLocaleDateString()})]}),e.jsx($,{variant:"outlined",size:"small",onClick:()=>I(s),children:"Export Signups"})]}),e.jsxs(u,{sx:{display:"flex",flexWrap:"wrap",gap:2,my:2},children:[e.jsx(j,{label:`Total Signups: ${s.total_signups}`}),e.jsx(j,{label:`Passengers Needing Lifts: ${s.passengers_needing_lifts}`}),e.jsx(j,{label:`Available Passenger Spaces: ${s.available_passenger_spaces}`,color:s.available_passenger_spaces>=s.passengers_needing_lifts?"success":"error"})]}),e.jsxs(N,{sx:{boxShadow:"none"},children:[e.jsx(k,{expandIcon:e.jsx(B,{}),children:e.jsx(o,{children:"View Signed-up Members"})}),e.jsx(P,{children:e.jsx(R,{dense:!0,children:s.members&&s.members.map(t=>e.jsx(F,{secondaryAction:s.requires_approval&&["Waiting List","Pending"].includes(t.status)&&e.jsxs(e.Fragment,{children:[e.jsx(C,{edge:"end",title:"Confirm",onClick:()=>w(t.signup_id,"Confirmed"),children:e.jsx(M,{color:"success"})}),e.jsx(C,{edge:"end",title:"Deny",sx:{ml:1},onClick:()=>w(t.signup_id,"Cancelled"),children:e.jsx(U,{color:"error"})})]}),children:e.jsx(q,{primary:t.name,secondary:(s.requires_approval?`Status: ${t.status} | `:"")+`Student No: ${t.student_number||"N/A"} | Role: ${t.role}`+(t.can_drive?` | Driving (${t.car_spaces} total seats)`:"")+(t.transport_needed?" | Needs Transport":"")})},t.signup_id))})})]})]},s.event_id);return f?e.jsx(o,{children:"Loading admin data..."}):v?e.jsxs(o,{color:"error",children:["Error: ",v]}):e.jsxs(u,{children:[e.jsxs(S,{elevation:4,sx:{p:{xs:2,sm:3},mb:4,borderRadius:2,textAlign:"center",background:"linear-gradient(45deg, #d32f2f 30%, #f44336 90%)",color:"white"},children:[e.jsx(o,{variant:"h4",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Admin Dashboard"}),e.jsx(o,{variant:"subtitle1",children:"Manage event signups, transport, and member approvals."})]}),e.jsx($,{variant:"contained",color:"warning",onClick:A,children:"Cache Old Images"}),e.jsxs(u,{sx:{my:4},children:[e.jsx(o,{variant:"h5",gutterBottom:!0,children:"Upcoming Events"}),g.length>0?g.map(y):e.jsx(o,{children:"No upcoming events with signups."})]}),e.jsx(L,{}),e.jsxs(u,{sx:{my:4},children:[e.jsx(o,{variant:"h5",gutterBottom:!0,children:"Past Events"}),h.length>0?h.map(y):e.jsx(o,{children:"No past events with signups."})]})]})}export{z as default};
