import{r as s,j as e,w as H,x as A,y as G,z as O,E as Y,i as h,G as M,J as N,K as F,B as W,N as z,O as B,Q as T,f as q,U as J,l as K,V as Q,C as V,P as X,W as Z,m as P,X as ee,Y as te}from"./vendor-DhX4SPbH.js";import{u as $,s as x,f as se}from"./index-Cgkqyj9w.js";const ae="https://jhhbluhsgqykccyivxei.supabase.co";function ne({event:t,initialSignupStatus:l}){const{profile:d,isAdmin:y}=$(),[k,C]=s.useState(!1),[m,v]=s.useState([]),[c,u]=s.useState(!!l),[p,w]=s.useState(l),[_,I]=s.useState(!1),[L,D]=s.useState(!1),[f,E]=s.useState(!1),[n,o]=s.useState("");s.useEffect(()=>{u(!!l),w(l)},[l]);const g=async()=>{C(!0),y&&await i()},a=()=>{v([]),C(!1)},i=async()=>{const{data:r,error:R}=await x.from("signups").select("*, users:users!signups_user_id_fkey(id, name, email)").eq("event_id",t.id);R?console.error("Error fetching signups:",R):v(r||[])},b=async()=>{if(!d)return;const r=t.requires_approval?"Waiting List":"Confirmed",{error:R}=await x.from("signups").insert([{user_id:d.id,event_id:t.id,can_drive:_,transport_needed:L,status:r}]);R?alert("Failed to sign up."):(a(),o(t.requires_approval?"Successfully added to waitlist!":"Successfully signed up!"),E(!0),u(!0),w(r))},j=()=>p==="Waiting List"?"On Waitlist":p||"Signed Up",S=r=>r==="Confirmed"?{color:"success",sx:{}}:r==="Cancelled"?{color:"error",sx:{}}:{color:"default",sx:{backgroundColor:"#757575",color:"white"}},U=t.image_url&&t.image_url.startsWith("http")?t.image_url:`${ae}/storage/v1/object/public/event-images/${t.image_url}`;return e.jsxs(e.Fragment,{children:[e.jsxs(H,{sx:{mb:2,position:"relative"},children:[c&&(t.requires_approval?e.jsx(A,{label:j(),...S(p),sx:{...S(p).sx,position:"absolute",top:8,right:8,zIndex:1}}):e.jsx(A,{label:"Signed Up",color:"success",sx:{position:"absolute",top:8,right:8,zIndex:1}})),e.jsxs(G,{onClick:g,children:[e.jsx(O,{component:"img",height:"140",image:U,alt:t.name}),e.jsxs(Y,{children:[e.jsx(h,{variant:"h5",children:t.name}),e.jsxs(h,{variant:"body2",color:"textSecondary",children:["ðŸ“… ",new Date(t.date).toLocaleDateString()]})]})]})]}),e.jsxs(M,{open:k,onClose:a,PaperProps:{sx:{zIndex:r=>r.zIndex.modal+1}},children:[e.jsx(N,{children:t.name}),e.jsxs(F,{children:[e.jsx(O,{component:"img",height:"200",image:U,alt:t.name,sx:{borderRadius:2,marginBottom:2}}),e.jsx(h,{variant:"body1",gutterBottom:!0,children:t.description||"No description available."}),e.jsxs(h,{variant:"body2",color:"textSecondary",children:["ðŸ“… ",new Date(t.date).toLocaleDateString()]}),!c&&((d==null?void 0:d.role)==="Driver"?e.jsx(W,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(z,{control:e.jsx(B,{checked:_,onChange:r=>I(r.target.checked)}),label:"I can drive"})}):e.jsx(W,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(z,{control:e.jsx(B,{checked:L,onChange:r=>D(r.target.checked)}),label:"I need Transport"})}))]}),e.jsxs(T,{children:[e.jsx(q,{onClick:a,children:"Close"}),c?t.requires_approval?e.jsx(A,{label:j(),...S(p),sx:{...S(p).sx,mr:2}}):e.jsx(h,{sx:{mr:2,color:"success.main"},children:"You are signed up!"}):e.jsx(q,{variant:"contained",onClick:b,children:t.requires_approval?"Request to Go":"Sign Up"})]})]}),e.jsx(J,{open:f,autoHideDuration:4e3,onClose:()=>E(!1),anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(K,{onClose:()=>E(!1),severity:"success",sx:{width:"100%"},children:n})})]})}function re({onFileAccepted:t}){const[l,d]=s.useState(null),y=s.useCallback(v=>{const c=v[0];c&&(d(URL.createObjectURL(c)),t(c))},[t]),{getRootProps:k,getInputProps:C,isDragActive:m}=Q({onDrop:y,accept:{"image/*":[".jpeg",".png",".gif",".webp"]},multiple:!1});return e.jsxs(W,{...k(),sx:{border:`2px dashed ${m?"primary.main":"grey.500"}`,borderRadius:2,p:3,textAlign:"center",cursor:"pointer",backgroundColor:m?"action.hover":"transparent",transition:"background-color 0.2s ease-in-out",mt:2,mb:1,backgroundImage:`url(${l})`,backgroundSize:"cover",backgroundPosition:"center",minHeight:150,display:"flex",alignItems:"center",justifyContent:"center"},children:[e.jsx("input",{...C()}),!l&&e.jsx(h,{color:"textSecondary",children:m?"Drop the image here...":"Drag 'n' drop an image here, or click to select"})]})}function le(){const{isAdmin:t}=$(),[l,d]=s.useState([]),[y,k]=s.useState(new Map),[C,m]=s.useState(!0),[v,c]=s.useState(!1),[u,p]=s.useState({name:"",date:"",location:"",description:"",requires_approval:!1}),[w,_]=s.useState(null);async function I(){m(!0);const{data:{user:n}}=await x.auth.getUser();if(!n){m(!1);return}const[o,g]=await Promise.all([x.from("events").select("*, requires_approval").order("date",{ascending:!0}),x.from("signups").select("event_id, status").eq("user_id",n.id)]);if(o.data){const a=new Date;a.setHours(0,0,0,0);const i=o.data.filter(b=>new Date(b.date)>=a);d(i)}if(g.data){const a=new Map(g.data.map(i=>[i.event_id,i.status]));k(a)}m(!1)}s.useEffect(()=>{I()},[]);const L=()=>c(!0),D=()=>{c(!1),_(null)},f=n=>{const{name:o,value:g,type:a,checked:i}=n.target;p({...u,[o]:a==="checkbox"?i:g})},E=async()=>{if(!u.name)return alert("Event name is required!");let n="";try{if(w){const a=w.name.split(".").pop(),i=`${Date.now()}.${a}`,{data:b,error:j}=await x.storage.from("event-images").upload(i,w);if(j)throw j;n=b.path}else{const a=await se(u.name);if(console.log(u.name),!(a!=null&&a.imageUrl))throw new Error("Could not fetch an image from Unsplash.");const b=await(await fetch(a.imageUrl)).blob(),j=`${Date.now()}.jpeg`,{data:S,error:U}=await x.storage.from("event-images").upload(j,b);if(U)throw U;n=S.path}const o={...u,image_url:n},{error:g}=await x.from("events").insert([o]);if(g)throw g;await I(),p({name:"",date:"",location:"",description:"",requires_approval:!1}),D()}catch(o){console.error("Error creating event:",o),alert(`Failed to create event: ${o.message}`)}};return C?e.jsx(h,{children:"Loading events..."}):e.jsxs(V,{maxWidth:"false",sx:{width:"100%",maxWidth:"1200px",p:3,borderRadius:2,backgroundColor:"rgba(255, 255, 255, 0.7)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.2)"},children:[e.jsxs(X,{elevation:4,sx:{p:{xs:2,sm:4},mb:4,borderRadius:2,textAlign:"center",background:"linear-gradient(45deg, #1976d2 30%, #42a5f5 90%)",color:"white"},children:[e.jsx(h,{variant:"h3",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Upcoming Events"}),e.jsx(h,{variant:"subtitle1",sx:{mb:2},children:"Browse and sign up for our latest sailing adventures."}),t&&e.jsx(q,{variant:"contained",color:"secondary",onClick:L,children:"+ New Event"})]}),e.jsx(Z,{columns:{xs:1,sm:2,md:3,lg:4},spacing:2,children:l.map(n=>e.jsx(ne,{event:n,initialSignupStatus:y.get(n.id)||null},n.id))}),e.jsxs(M,{open:v,onClose:D,children:[e.jsx(N,{children:"Create New Event"}),e.jsxs(F,{children:[e.jsx(P,{label:"Event Name",name:"name",fullWidth:!0,onChange:f,sx:{my:1}}),e.jsx(P,{label:"Date",name:"date",type:"date",fullWidth:!0,onChange:f,InputLabelProps:{shrink:!0},sx:{my:1}}),e.jsx(P,{label:"Location",name:"location",fullWidth:!0,onChange:f,sx:{my:1}}),e.jsx(re,{onFileAccepted:_}),e.jsx(ee,{name:"description",minRows:3,placeholder:"Enter event description...",style:{width:"100%",padding:"8px"},onChange:f}),e.jsx(z,{control:e.jsx(te,{checked:u.requires_approval,onChange:f,name:"requires_approval"}),label:"Waitlist / Requires Approval",sx:{mt:1}})]}),e.jsxs(T,{children:[e.jsx(q,{onClick:D,children:"Cancel"}),e.jsx(q,{onClick:E,variant:"contained",children:"Create"})]})]})]})}export{le as default};
