import{r as a,j as e,w as G,x as I,y as J,z as R,E as K,i as u,G as z,J as B,K as N,L as Q,b as V,e as X,B as M,N as W,O as T,Q as P,f as y,U as Y,l as Z,P as $,V as ee,m as q,W as se,X as te}from"./vendor-mLxMphKg.js";import{u as F,s as v,f as ae}from"./index-COGqSMdW.js";function ne({event:s,initialSignupStatus:m}){const{profile:p,isAdmin:S}=F(),[L,w]=a.useState(!1),[f,_]=a.useState([]),[C,i]=a.useState(!!m),[o,k]=a.useState(m),[b,h]=a.useState(!1),[E,n]=a.useState(!1),[x,l]=a.useState(!1),[c,r]=a.useState("");a.useEffect(()=>{i(!!m),k(m)},[m]);const d=async()=>{w(!0),S&&await U()},j=()=>{_([]),w(!1)},U=async()=>{const{data:t,error:g}=await v.from("signups").select("*, users:users!signups_user_id_fkey(id, name, email)").eq("event_id",s.id);g?console.error("Error fetching signups:",g):_(t||[])},H=async()=>{if(!p)return;const t=s.requires_approval?"Waiting List":"Confirmed",{error:g}=await v.from("signups").insert([{user_id:p.id,event_id:s.id,can_drive:b,transport_needed:E,status:t}]);g?(console.error("Error signing up:",g),alert("Failed to sign up.")):(j(),r(s.requires_approval?"Successfully added to waitlist!":"Successfully signed up!"),l(!0),i(!0),k(t))},A=()=>o==="Waiting List"?"On Waitlist":o,D=t=>t==="Confirmed"?{color:"success"}:t==="Cancelled"?{color:"error"}:{color:"default",sx:{backgroundColor:"#757575",color:"white"}};return e.jsxs(e.Fragment,{children:[e.jsxs(G,{sx:{mb:2,position:"relative"},children:[C&&(s.requires_approval?e.jsx(I,{label:A(),...D(o),sx:{...D(o).sx,position:"absolute",top:8,right:8,zIndex:1}}):e.jsx(I,{label:"Signed Up",color:"success",sx:{position:"absolute",top:8,right:8,zIndex:1}})),e.jsxs(J,{onClick:d,children:[e.jsx(R,{component:"img",height:"140",image:s.image_url||"/default-event.jpg",alt:s.name}),e.jsxs(K,{children:[e.jsx(u,{variant:"h5",children:s.name}),e.jsxs(u,{variant:"body2",color:"textSecondary",children:["ðŸ“… ",new Date(s.date).toLocaleDateString()]})]})]})]}),e.jsxs(z,{open:L,onClose:j,PaperProps:{sx:{zIndex:t=>t.zIndex.modal+1}},children:[e.jsx(B,{children:s.name}),e.jsxs(N,{children:[s.image_url&&e.jsx(R,{component:"img",height:"200",image:s.image_url,alt:s.name,sx:{borderRadius:2,marginBottom:2}}),e.jsx(u,{variant:"body1",gutterBottom:!0,children:s.description||"No description available."}),e.jsxs(u,{variant:"body2",color:"textSecondary",children:["ðŸ“… ",new Date(s.date).toLocaleDateString()]}),S&&f.length>0&&e.jsxs("div",{children:[e.jsxs(u,{variant:"h6",sx:{mt:2},children:["Signups: ",f.length]}),e.jsx(Q,{children:f.map(t=>{var g,O;return e.jsx(V,{children:e.jsx(X,{primary:((g=t.users)==null?void 0:g.name)||"Unknown User"})},((O=t.users)==null?void 0:O.id)||Math.random())})})]}),!C&&((p==null?void 0:p.role)==="Driver"?e.jsx(M,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(W,{control:e.jsx(T,{checked:b,onChange:t=>h(t.target.checked)}),label:"I can drive"})}):e.jsx(M,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(W,{control:e.jsx(T,{checked:E,onChange:t=>n(t.target.checked)}),label:"I need Transport"})}))]}),e.jsxs(P,{children:[e.jsx(y,{onClick:j,children:"Close"}),C?s.requires_approval?e.jsx(I,{label:A(),...D(o),sx:{...D(o).sx,mr:2}}):e.jsx(u,{sx:{mr:2,color:"success.main"},children:"You are signed up!"}):e.jsx(y,{variant:"contained",onClick:H,children:s.requires_approval?"Request to Go":"Sign Up"})]})]}),e.jsx(Y,{open:x,autoHideDuration:4e3,onClose:()=>l(!1),anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(Z,{onClose:()=>l(!1),severity:"success",sx:{width:"100%"},children:c})})]})}function oe(){const{isAdmin:s}=F(),[m,p]=a.useState([]),[S,L]=a.useState(new Map),[w,f]=a.useState(!0),[_,C]=a.useState(!1),[i,o]=a.useState({name:"",date:"",location:"",image_url:"",description:"",requires_approval:!1});a.useEffect(()=>{async function n(){f(!0);const{data:{user:x}}=await v.auth.getUser();if(!x){f(!1);return}const[l,c]=await Promise.all([v.from("events").select("*, requires_approval").order("date",{ascending:!0}),v.from("signups").select("event_id, status").eq("user_id",x.id)]);if(l.data){const r=new Date;r.setHours(0,0,0,0);const d=l.data.filter(j=>new Date(j.date)>=r);p(d)}if(c.data){const r=new Map(c.data.map(d=>[d.event_id,d.status]));L(r)}f(!1)}n()},[]);const k=()=>C(!0),b=()=>C(!1),h=n=>{const{name:x,value:l,type:c,checked:r}=n.target;o({...i,[x]:c==="checkbox"?r:l})},E=async()=>{if(!i.name)return alert("Event name is required!");let n=i.image_url;n||(n=await ae(i.name));const x={...i,image_url:n||"default-image-url.jpg"},{data:l,error:c}=await v.from("events").insert([x]).select();if(c)console.error("Error creating event:",c);else{const{data:r}=await v.from("events").select("*, requires_approval").order("date",{ascending:!0});if(r){const d=new Date;d.setHours(0,0,0,0);const j=r.filter(U=>new Date(U.date)>=d);p(j)}o({name:"",date:"",location:"",image_url:"",description:"",requires_approval:!1}),b()}};return w?e.jsx(u,{children:"Loading events..."}):e.jsxs(M,{children:[e.jsxs($,{elevation:4,sx:{p:{xs:2,sm:4},mb:4,borderRadius:2,textAlign:"center",background:"linear-gradient(45deg, #1976d2 30%, #42a5f5 90%)",color:"white"},children:[e.jsx(u,{variant:"h4",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Upcoming Events"}),e.jsx(u,{variant:"subtitle1",sx:{mb:2},children:"Browse and sign up for our latest sailing adventures."}),s&&e.jsx(y,{variant:"contained",color:"secondary",onClick:k,children:"+ New Event"})]}),e.jsx(ee,{columns:{xs:1,sm:2,md:3,lg:4},spacing:2,children:m.map(n=>e.jsx(ne,{event:n,initialSignupStatus:S.get(n.id)||null},n.id))}),e.jsxs(z,{open:_,onClose:b,children:[e.jsx(B,{children:"Create New Event"}),e.jsxs(N,{children:[e.jsx(q,{label:"Event Name",name:"name",fullWidth:!0,onChange:h,sx:{my:1}}),e.jsx(q,{label:"Date",name:"date",type:"date",fullWidth:!0,onChange:h,InputLabelProps:{shrink:!0},sx:{my:1}}),e.jsx(q,{label:"Location",name:"location",fullWidth:!0,onChange:h,sx:{my:1}}),e.jsx(q,{label:"Image URL",name:"image_url",fullWidth:!0,onChange:h,sx:{my:1}}),e.jsx(se,{name:"description",minRows:3,placeholder:"Enter event description...",style:{width:"100%",padding:"8px"},onChange:h}),e.jsx(W,{control:e.jsx(te,{checked:i.requires_approval,onChange:h,name:"requires_approval"}),label:"Waitlist / Requires Approval",sx:{mt:1}})]}),e.jsxs(P,{children:[e.jsx(y,{onClick:b,children:"Cancel"}),e.jsx(y,{onClick:E,variant:"contained",children:"Create"})]})]})]})}export{oe as default};
