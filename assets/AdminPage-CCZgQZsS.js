import{r as c,j as e,f as n,B as d,P as y,D as E,g as $,x as m,$ as A,a0 as L,a1 as N,a2 as I,L as B,b as P,e as k,I as w,a3 as R,a4 as M}from"./vendor-Bc-sSxl_.js";import{s as S}from"./index-C1q0tQq3.js";const U=(l,h,u)=>{const x=["Event Name","Event Date","Member Name","Student Number","Role","Can Drive","Needs Transport","Status"],g=l.map(i=>[`"${h}"`,`"${u}"`,`"${i.name}"`,`"${i.student_number||""}"`,`"${i.role}"`,i.can_drive,i.transport_needed,`"${i.status}"`].join(","));return[x.join(","),...g].join(`
`)};function W(){const[l,h]=c.useState([]),[u,x]=c.useState([]),[g,i]=c.useState(!0),[f,D]=c.useState(null);async function _(){try{const{data:s,error:t}=await S.rpc("get_event_transport_details");if(t)throw t;const o=new Date;o.setHours(0,0,0,0);const a=[],p=[];(s||[]).forEach(r=>{new Date(r.event_date)>=o?a.push(r):p.push(r)}),h(a.sort((r,j)=>new Date(r.event_date)-new Date(j.event_date))),x(p.sort((r,j)=>new Date(j.event_date)-new Date(r.event_date)))}catch(s){console.error("Error fetching admin data:",s),D(s.message)}finally{i(!1)}}c.useEffect(()=>{_()},[]);const v=async(s,t)=>{const{error:o}=await S.from("signups").update({status:t}).eq("id",s);o?alert("Failed to update status."):await _()},C=s=>{if(!s.members||s.members.length===0){alert("There are no signups to export for this event.");return}const t=U(s.members,s.event_name,s.event_date),o=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),p=URL.createObjectURL(o);a.setAttribute("href",p);const r=s.event_name.replace(/[^a-z0-9]/gi,"_").toLowerCase();a.setAttribute("download",`${r}_signups.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},b=s=>e.jsxs(y,{sx:{mb:3,p:3,boxShadow:3,borderRadius:2},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(n,{variant:"h5",children:s.event_name}),e.jsx(n,{variant:"body2",color:"textSecondary",children:new Date(s.event_date).toLocaleDateString()})]}),e.jsx($,{variant:"outlined",size:"small",onClick:()=>C(s),children:"Export Signups"})]}),e.jsxs(d,{sx:{display:"flex",flexWrap:"wrap",gap:2,my:2},children:[e.jsx(m,{label:`Total Signups: ${s.total_signups}`}),e.jsx(m,{label:`Passengers Needing Lifts: ${s.passengers_needing_lifts}`}),e.jsx(m,{label:`Available Passenger Spaces: ${s.available_passenger_spaces}`,color:s.available_passenger_spaces>=s.passengers_needing_lifts?"success":"error"})]}),e.jsxs(A,{sx:{boxShadow:"none"},children:[e.jsx(L,{expandIcon:e.jsx(N,{}),children:e.jsx(n,{children:"View Signed-up Members"})}),e.jsx(I,{children:e.jsx(B,{dense:!0,children:s.members&&s.members.map(t=>e.jsx(P,{secondaryAction:s.requires_approval&&["Waiting List","Pending"].includes(t.status)&&e.jsxs(e.Fragment,{children:[e.jsx(w,{edge:"end",title:"Confirm",onClick:()=>v(t.signup_id,"Confirmed"),children:e.jsx(R,{color:"success"})}),e.jsx(w,{edge:"end",title:"Deny",sx:{ml:1},onClick:()=>v(t.signup_id,"Cancelled"),children:e.jsx(M,{color:"error"})})]}),children:e.jsx(k,{primary:t.name,secondary:(s.requires_approval?`Status: ${t.status} | `:"")+`Student No: ${t.student_number||"N/A"} | Role: ${t.role}`+(t.can_drive?` | Driving (${t.car_spaces} total seats)`:"")+(t.transport_needed?" | Needs Transport":"")})},t.signup_id))})})]})]},s.event_id);return g?e.jsx(n,{children:"Loading admin data..."}):f?e.jsxs(n,{color:"error",children:["Error: ",f]}):e.jsxs(d,{children:[e.jsxs(y,{elevation:4,sx:{p:{xs:2,sm:3},mb:4,borderRadius:2,textAlign:"center",background:"linear-gradient(45deg, #d32f2f 30%, #f44336 90%)",color:"white"},children:[e.jsx(n,{variant:"h4",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Admin Dashboard"}),e.jsx(n,{variant:"subtitle1",children:"Manage event signups, transport, and member approvals."})]}),e.jsxs(d,{sx:{my:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Upcoming Events"}),l.length>0?l.map(b):e.jsx(n,{children:"No upcoming events with signups."})]}),e.jsx(E,{}),e.jsxs(d,{sx:{my:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Past Events"}),u.length>0?u.map(b):e.jsx(n,{children:"No past events with signups."})]})]})}export{W as default};
